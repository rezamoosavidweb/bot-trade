from telethon import TelegramClient, events
import re
import asyncio
from telethon.errors import FloodWaitError
# --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
api_id = 27396957
api_hash = '53e16a90d89a28a0a67bb95ca3dff324'

source_channel = 'CryptoSignalsGolden'   # Ú©Ø§Ù†Ø§Ù„ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø±Ø±Ø³ÛŒ Ø´ÙˆØ¯
target_channel = -1002383929199 #BullishBearish



async def safe_send_message(client, channel, text):
    while True:
        try:
            await client.send_message(channel, text)
            await asyncio.sleep(1.5)  # ÙØ§ØµÙ„Ù‡ Ø§Ù…Ù† Ø¨ÛŒÙ† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
            break
        except FloodWaitError as e:
            wait_time = e.seconds + 5
            print(f"Flood detected. Sleeping {wait_time} seconds...")
            await asyncio.sleep(wait_time)

# --- ØªØ§Ø¨Ø¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù… ---
def process_message(text: str):
    print(f"================================================\nProcessing profit\n{text}")

    pattern = r'[A-Z]+USDT\s+:\s*([+-]?\d+\.\d+)%'
    numbers = re.findall(pattern, text)
    numbers = [float(n) for n in numbers]

    if not numbers:
        return None

    positives = [n for n in numbers if n > 0]
    negatives = [n for n in numbers if n < 0]

    # ğŸ”¹ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ú©ÙˆÚ†Ú©ØªØ±ÛŒÙ† Ø¹Ø¯Ø¯ Ù…Ø«Ø¨Øª <= 20
    valid_small_positives = [n for n in positives if n <= 20]

    if valid_small_positives:
        replacement_value = min(valid_small_positives)
    else:
        replacement_value = 15.0  # Ø§Ú¯Ø± Ù‡Ù…Ù‡ Ù…Ø«Ø¨Øªâ€ŒÙ‡Ø§ > 20 Ø¨ÙˆØ¯Ù†Ø¯

    # ğŸ” Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ
    final_positives = [
        n if n <= 20 else replacement_value
        for n in positives
    ]

    total_positive = sum(final_positives)
    total_negative = sum(negatives)
    total = total_positive + total_negative

    return (
        f"ğŸ“Š Result Summary\n\n"
        f"ğŸŸ¢ Ø§Ø¹Ø¯Ø§Ø¯ Ù…Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ:\n{final_positives}\n\n"
        f"ğŸš« Ø§Ø¹Ø¯Ø§Ø¯ Ù…Ù†ÙÛŒ:\n{negatives}\n\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
        f"ğŸŸ¢ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø«Ø¨Øª: {len(final_positives)}\n"
        f"ğŸš« ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ù†ÙÛŒ: {len(negatives)}\n"
        f"â• Ø¬Ù…Ø¹ Ø³ÙˆØ¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø«Ø¨Øª: {total_positive:.2f}%\n"
        f"â– Ø¬Ù…Ø¹ Ø¶Ø±Ø± Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ù†ÙÛŒ: {total_negative:.2f}%\n\n"
        f"ğŸ’° Ø³ÙˆØ¯ Ù†Ù‡Ø§ÛŒÛŒ: {total:.2f}%"
    )



# --- Ø³Ø§Ø®Øª Ú©Ù„Ø§ÛŒÙ†Øª ---
client = TelegramClient('session_name', api_id, api_hash)

# --- Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú¯Ø°Ø´ØªÙ‡ ---
async def process_old_messages():
    async for message in client.iter_messages(source_channel, limit=None):
        text = message.message
       
        
        # â›” Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ù…ØªÙ† Ù†Ø¯Ø§Ø´ØªØŒ Ø±Ø¯ Ø´Ùˆ
        if not text:
            continue
        # print(text)
        if text.startswith("ğŸ“ˆ Last 24 hours results"):
            await safe_send_message(
                client,
                target_channel,
                f"ğŸ“¥ from @{source_channel}\n\n{text}"
            )
            # print(text)
            print('sended to target channel.')
            result = process_message(text)
            if result:
                await safe_send_message(
                    client,
                    target_channel,
                    result
                )

# --- Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ ---
@client.on(events.NewMessage(chats=source_channel))
async def new_message_handler(event):
    text = event.message.message

    if not text:
        return

    if text.startswith("ğŸ“ˆ Last 24 hours results"):
        await client.send_message(
            target_channel,
            f"ğŸ“¥ received new message:\n\n{text}"
        )

        result = process_message(text)
        print("new message found.")
        await safe_send_message(client, target_channel, result)


# --- Ø§Ø¬Ø±Ø§ÛŒ Ú©Ù„Ø§ÛŒÙ†Øª ---
async def main():
    print("Processing old messages...")
    await process_old_messages()
    print("Listening for new messages...")
    await client.run_until_disconnected()

with client:
    client.loop.run_until_complete(main())
